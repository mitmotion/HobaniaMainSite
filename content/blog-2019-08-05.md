+++
title = "This Week In Veloren 27"
description = ""

date = 2019-08-05
weight = 0
slug = "devblog-27"
+++

Thanks to all of the contributors this week, @Pfauenauge, @Qutrin, @xacrimon, @tommywatson, @Muqito, @Vechro, @Nero, @Imbris, @sheldon_knuth, @Timo, and @Zesterer!

## Saturday Screenshot Winner

Thanks to @Pfauenauge for this week's screenshot. We're excited to see what comes out next week!

<img src="https://cdn.discordapp.com/attachments/541307708146581519/605415582472470659/ZDYfRCvBZ5szsQ83Nbd8CgRfwrgV2z8TCI78oJ2stQs295n9n5Vm6jxei7o6ep4fiR7gOH5X60hdv8aeWExTY4tGyYjEZPPyBkmB.png"/>

> Experimenting with new objects and lighting to make this cozy cabin!

# Programming

## 0.3 Release

This week, 0.3 was released! This version was a longtime coming, and there has been a ton added to Veloren. Here is a small list of the major changes in this version:

```
+ XP and levelling
+ Better combat, movement, and animations
+ Enemies, bosses
+ Better world generation, more biomes
+ Build mode
+ Caves, lanterns, lights, dungeons
+ Character customisation, multiple races
+ Inventories (WIP)
+ Day/night, better shaders, voxel shadows
+ Many performance optimisations
```

You can download 0.3 on the main website [here](https://veloren.net/welcome/)

We are excited to start work on 0.4. We will be having a meeting in the next week or so to discuss what our goals are for the next release.

## Graphics Analysis by @Vercidium

This week, @Vercidium stopped into the Discord. They are a developer currently working on a voxel game [Sector's Edge](https://sectorsedge.com/). With their knowledge of graphics debugging, they were able to give us a lot of info about how Veloren is running. @YuriMomo, our resident graphic analysist, and them had some good discussions on this topic. Here is what we got from @Vercidium

<img src="https://cdn.discordapp.com/attachments/467861297279533066/606133365711568907/unknown.png">

SM, lighting calculations in the fragment shader, are running at 54% efficiency, which is alright for a post-processor, but for vertex processing it shouldn't be the top performer. VRAM and VAF (vertex attribute fetch) is running at around 16% efficiency. Shaders are running for 76% of the time, 24% of the time they are waiting on memory access (short scoreboard). You've got no texture stalling (long scoreboard) as there's no textures in the fragment shader. Woohoo! 722000 triangles (2.1 million vertices) are being rendered. Need to combine faces or have an Level of Depth system to improve this

<img src="https://cdn.discordapp.com/attachments/467861297279533066/606135020632932352/unknown.png">

Viewport culling (VPC) is being overworked, you need to cull the chunks that are outside the screen. There are currently 4.6 million triangles with 13.9 million vertices being rendered every frame. That's 106mb of data loading from VRAM. Veloren currently has 1494 `Wait for Idle Count` while my game has 3 every frame. `Wait for Idle` is caused when there are other GPU commands being sent between draw calls. Graphics/Compute Idle has risen from 0.37% to 25%.

The entire GPU pipeline is inactive for 25% of the time waiting for a command from the CPU to arrive. Something is definitely happening between draw calls. Note this was profiled after all the chunks have been generated and CPU usage was around 7%. SM efficiency has reduced by over a half (21.5%), meaning the shader is either waiting for memory access or waiting for commands to run.

Chunks are seemingly rendered in a random order, and to a framebuffer with RGBA_16F format. Colour read/write operation is at 13% efficiency, that will boost up quite a bit if you render to a RGB_8I framebuffer (3 bytes, red green blue). 24 outgoing bits per pixel rather than 64. Rendering to 3 render targets in my game runs 3x slower than rendering to one, so that's an easy and quick fix.

I'd highly, highly recommend merging faces and use a texture in the fragment shader to slightly darken random blocks. I think the entire 32x32 texture would fit inside the L2 cache. The character is composed of 16142 triangles, hopefully that can be reduced (thats heaps). Multisampling is enabled, I'd add an option in the settings to disable this, mainly for users with lower-end hardware. Depth func is set to LEQUAL, change this to LESS for a tiny performance boost. Buffers are bound for GL_DYNAMIC_DRAW. Apart from building/destroying blocks, are chunk meshes updated at all after they are initially drawn? If not, set this to GL_STATIC_DRAW. There are heaps of glVertexAttribDivisor and glVertexAttribIPointer calls every frame. Are VAOs being used? That way you only have to call these once

There are 207 Zero Fragment Draw errors, meaning 207 out of the 780 chunks drawn each frame are either hidden by another chunk or completely outside the viewport. 26 of these are hidden by another chunk, the other 181 are completely outside the viewport. With an average of 20000 triangles in each of these chunks, thats 4.1 million vertices (1/3rd of all vertices) wasted.

## Other Work

@Qutrin has been working on adding some more content to the progression system. Now, as you level up, you'll gain more health. @Timo also added a bit to the progression system, with making XP gain dependant on the level of the enemy killed.

A new Request For Comments (RFC) system has been created. RFCs allow ideas that are more complex to have discussion specifically around them. This is particularily useful for design ideas. Some new sections in the `Game Design` section of the Discord server make use of RFCs. Take a look at the RFC repo [here](https://gitlab.com/veloren/rfcs).

@Timo worked on some network performance improvements to phisics updates. When nothing changes, updates are no longer sent to the client. @Xacrimon has been working for a while now on memory improvements, and has made strides implementing a datascructure for storing entities more densly in memory. More to come on this in upcoming weeks.