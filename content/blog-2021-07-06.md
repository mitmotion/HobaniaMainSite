+++
title = "This Week In Veloren 127"
description = "New developer repo"

date = 2021-07-06
weight = 0
slug = "devblog-127"

[extra]
banner = ""

[taxonomies]
tags = ["devblog"]
+++

This week, we get an overview of changes to how development will be done on
Gitlab. Lots of new models were added, and we say farewell to a longtime core
developer.

\- AngelOnFira, TWiV Editor

# Contributor Work

Thanks to this week's contributors, @Snowram, @XVar, @xMAC94x, @imbris, @tygyh,
@aweinstock, @juliancoffee, @Yusdacra, @drunkonhotcoco, @Slipped, @nwildner,
@teenjuna, @Danacus, @a1phyr, @SWilliamsGames, @zesterer, @Sam, and
@AldanTanneo!

@Snowram I added death SFX and VFX, also made dungeon entrances spawn depending on biomes (MR yet to be reviewed)

@Christof I just started a redesign of the economic simulation to support new items and game mechanics introduced in the past six months. With housing, gliders, lanterns, ores, coal, and gems added the new schema feels more adequate but is still work in progress. Making the conversion between items and economic wares more reasonable is the major goal here

@Mckol I've been working on a few small improvements to Torvus such as adding /version and /help commands.

@juliancoffee I was doing food rework after consuming animations got merged, now most of the food heals you in 5-10 seconds and starts when you sit down. And we got second food which gives you two effects at the same time - Mushroom Curry:curry: . It requires you to patiently eat it and then gives you quick saturtion buff which restores you 50 HP and long-lasting regeneration buff, which slowly heals you for more than a minute!
As for small fixes, merchants now can sell and buy most of the items with reasonable prices (when Mushroom Curry costs more than its ingredients). They can even buy Mindflayer spellbag though quite frequently they don't have coins that you would want for it.
Yeti difficulty was adjusted as for beginner dungeon.

### Disabling Nagle's algorithm
In order to debug some networking performance issues, I added some instrumentation of network requests to the client using the tracy tracing profiler. 
This revealed that messages on the ingame stream (which is meant to handle low-latency data like entity position updates and client inputs) were being delivered in batches.

Graph showing nearly a full second of latency, after which 6 messages were delivered at once:
https://cdn.discordapp.com/attachments/767442908767977473/858738641882710046/2021-06-27-120031_1366x768_scrot.png

This turned out to be a result of not disabling Nagle's algorithm/enabling TCP_NODELAY. 
Nagle's algorithm maintains a buffer of small messages, only sending a TCP packet when it's full. This trades away latency to improve throughput, which is the opposite of what's desired for the ingame stream. As a result of disabling Nagle's algorithm, input handling and entity movement should be smoother.

{{
  img(src="https://cdn.discordapp.com/attachments/767442908767977473/858738641882710046/2021-06-27-120031_1366x768_scrot.png")
}}

### Attempts to improve lossy terrain compression
I also tried to improve terrain compression by using 256-color palettes per block kind.
This should allow for sending terrain that's a third of the size (since it's 1 byte per voxel for color data instead of 3 bytes for rgb triples), while still being fairly high quality (since Grass has 256 shades of green, Wood has 256 shades of brown, and so on).
The slow part of using a palette on terrain is finding the closest color to the original color, which can be sped up relative to linear search by treating the colors as vectors and using spatial datastructures like kd-trees and R*-trees to find nearest neighbors of a color by euclidean distance.
While this was a success compression ratio wise (a full resolution chunk can be stored at 6% of an in-memory chonk with quantized colors, compared to the 17% or so of deflate or full resolution unquantized png), it was an order of magnitude slower than either deflate or quarter resolution png (the previous best lossy compression format, at 3% ratio, with noticable artifacts), rendering it unsuitable for realtime compression of terrain chunks.

Graph showing average compression time vs chunk height for a set of chunks near a dungeon:
https://cdn.discordapp.com/attachments/767442908767977473/860206915505881088/compression_speeds_dungeon_192.png

### Bugfixes

I gave a few more materials nonzero prices, which results in most metal and hide armor being valued by NPC merchants.
Cloth isn't being given a price yet since cloth is considered too easy to acquire via chunk reloading, this is intended to be addressed by modeling plant growth.

I also fixed a longstanding bug with underwater campfires, they now no longer emit smoke or light when they get put out by being submerged under water:
https://cdn.discordapp.com/attachments/767442908767977473/859921494015344650/screenshot_1625091648378.png

{{ support() }}
