+++
title = "This Week In Veloren 65"
description = ""

date = 2020-03-30
weight = 0
slug = "devblog-65"

[extra]
banner = "https://cdn.discordapp.com/attachments/523568428905398283/703665712199106689/unknown.png"

[taxonomies]
tags = ["devblog"]
+++



\- AngelOnFira, TWiV Editor

# Contributor Work

Thanks to this week's contributors, @Zesterer, @Pfau, @Slipped, @CapsizeGlimmer, @Songtronix, @xMAC94x, and @Treeco!

@Zesterer has been hard at work with projectile collision fixes, as well as a new level of detail system for entities and terrain sprites. @Capucho has been trudging through lots of work to get wgpu working for different systems in Veloren. They are currently working on the main menu UI, as well as the character menu.

@Songtonix is working through many improvements to Airshipper. The next version will offer macOS builds, as well as stable versions of Veloren rather than just nightly. 

@Sharp has worked on lots of improvements to the LoD branch. Better lighting, including time-dependent and point light-dependent HDR, more efficient / better use of pixels, proper atmospheric scattering, replacing magic constants with derived quantities, and a lot of other things, in addition to various other fixes needed to work with civsim.

Game design met to discuss the schools of magic, possibility of spell crafting, "endless" sky islands and caves for exploration, as well as touch on the goals for the Points of Interest. They also decided to address equipment and crafting during the next meeting.

# Tarpaulin and toolchains by @AngelOnFira

Tarpaulin has broken recently on our continuous integration (CI) pipeline. Tarpaulin is used to keep track of "code coverage" on the project. When we run tests, we want to make sure it touches as close to 100% of the code if possible. That way there isn't code that is completly ignored. In practice, we really don't have that much code coverage, but that's not the problem here. Tarpaulin breaking is!

Diagnosing this problem took some work. Although I love working with CI, my Rust skills aren't amazing. And this problem was starting to look more like a Rust one. Luckly I was able to follow a trail of breadcrumbs through areas that I would normally get stuck.

In our CI, we were getting this error while running Tarpaulin:

```
[INFO tarpaulin] Creating config
[INFO tarpaulin] Running Tarpaulin
[INFO tarpaulin] Building project
error: toolchain 'nightly-x86_64-unknown-linux-gnu' is not installed
Error: "Failed to report coverage! Error: No coverage results collected."
```

With my limited knowledge of how Rust toolchains work, I set off to learn more about them. I knew our CI had a version of nightly installed, so I first tried to lock down exactly which version. We use the `rust-toolchain` version to specify a date of nightly that we want. Since the toolchain would be the same on my local version of Veloren, I could just run `rustup toolchian list` to see the exact version.

`nightly-2020-04-17-x86_64-unknown-linux-gnu`

Interesting, it appears that Tarpaulin is ignoring the date. I did [some research](https://github.com/rust-lang/rustup#toolchain-specification) to find out more about the Rust toolchain specification. Next up was to figure out how Tarpaulin gets the toolchain name.

After cloning the Tarpaulin repo, I didn't really know where to look. I searched for "toolchain", "is not installed", and "nightly". I didn't really know what I was looking at, but I stumbled across this function:

```
fn create_command(manifest_path: &str, config: &Config, ty: &RunType) -> Command {
    let mut test_cmd = Command::new("cargo");
    if *ty == RunType::Doctests {
        test_cmd.args(&["+nightly", "test"]);
    } else {
        if let Ok(toolchain) = env::var("RUSTUP_TOOLCHAIN") {
            if toolchain.starts_with("nightly") {
                test_cmd.arg("+nightly");
            } else if toolchain.starts_with("beta") {
                test_cmd.arg("+beta");
            }
        }
        ...
    }
}
```

There was some stuff in here that looked sort of useful, but it wasn't until I came back to it a few times that I started playing with it. I had to learn how to install a cargo command from a local path, which wasn't too bad: `cargo install --path <path>`. Then I could debug nice and quickly! I added an info message that would print the toolchain it was getting from the env variable, and low and behold, it was what we wanted!

`nightly-2020-04-17-x86_64-unknown-linux-gnu`

Next, I changed `test_cmd.arg("+nightly");` to be `test_cmd.arg("+nightly-2020-04-17-x86_64-unknown-linux-gnu);`. Running this fixed the original problem, and the right toolchain was being used. Great success! Now that I had a fix, it's time to get it into Tarpaulin. I swapped out some code to just use the env variable if it was available.

```
if let Ok(toolchain) = env::var("RUSTUP_TOOLCHAIN") {
    test_cmd.arg(format!("+{}", toolchain));
}
```

As far as I know, this solution should work any case. I'm waiting on it to get merged, but we should be able to patch our CI manually in the meantime. This wasn't that complicated of a problem, but I learned a lot on the way!